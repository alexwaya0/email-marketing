{% extends 'sender/base.html' %}
{% load static %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-envelope"></i> Email List</h2>
    <p>Total emails: <span id="total">{{ total }}</span> | Showing: <span id="showing">{{ emails.count }}</span></p>
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-[#1A3C34]"></i>
            <input type="text" id="searchInput" placeholder="Search by username or email" class="pl-10 w-full">
        </div>

        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <a href="{% url 'add_email' %}" class="btn"><i class="fas fa-plus"></i> Add Email</a>
            <button id="showDuplicatesBtn" class="btn bg-red-600 hover:bg-red-700 text-white flex items-center gap-2">
                <i class="fas fa-exclamation-triangle"></i> Find Duplicates (<span id="duplicateCount">0</span>)
            </button>
            <a href="{% url 'send_emails' %}" class="btn bg-blue-600 hover:bg-blue-700 text-white"><i class="fas fa-paper-plane"></i> Send to All</a>
        </div>
    </div>
    <form method="post" id="emailForm">
        {% csrf_token %}
        <div class="overflow-x-auto">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>#</th>
                        <th class="cursor-pointer sortable" data-sort="username">Username <i class="fas fa-sort ml-2"></i></th>
                        <th class="cursor-pointer sortable" data-sort="email">Email <i class="fas fa-sort ml-2"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="emailTableBody">
                    {% for email in emails %}
                    <tr data-username="{{ email.username }}" data-email="{{ email.email }}">
                        <td><input type="checkbox" name="email_ids" value="{{ email.id }}"></td>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ email.username }}</td>
                        <td>{{ email.email }}</td>
                        <td>
                            <a href="{% url 'delete_email' email.pk %}" class="text-red-500 hover:underline"><i class="fas fa-trash-alt"></i> Delete</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-4 text-sm"><i class="fas fa-inbox"></i> No emails found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-4 flex gap-2">
            <button type="button" id="sendSelectedBtn" class="btn bg-green-600 hover:bg-green-700 text-white"><i class="fas fa-paper-plane"></i> Send to Selected</button>
            <button type="button" id="deleteSelectedBtn" class="btn bg-red-600 hover:bg-red-700 text-white"><i class="fas fa-trash-alt"></i> Delete Selected</button>
        </div>
    </form>
</div>

<div id="duplicateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3">
            <h3 class="text-lg font-bold">Duplicate Emails</h3>
            <button id="closeModalBtn" class="text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
        </div>
        <div class="mt-2 text-gray-600">
            <p>Found <span id="modalDuplicateCount">0</span> duplicate emails.</p>
            <div id="duplicateList" class="mt-4 max-h-64 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentSort = { by: null, dir: 'asc' };

        // Function to update duplicates
        function updateDuplicates() {
            const emailRows = document.querySelectorAll('#emailTableBody tr:not([colspan])');
            const emailList = [];
            emailRows.forEach(row => {
                const email = row.dataset.email.trim().toLowerCase();
                emailList.push(email);
            });

            const seenEmails = new Set();
            const duplicates = new Set();
            emailList.forEach(email => {
                if (seenEmails.has(email)) {
                    duplicates.add(email);
                }
                seenEmails.add(email);
            });

            const duplicateCountElement = document.getElementById('duplicateCount');
            const modalDuplicateCountElement = document.getElementById('modalDuplicateCount');
            duplicateCountElement.textContent = duplicates.size;
            modalDuplicateCountElement.textContent = duplicates.size;

            const duplicateListContainer = document.getElementById('duplicateList');
            duplicateListContainer.innerHTML = '';
            if (duplicates.size > 0) {
                duplicates.forEach(email => {
                    const p = document.createElement('p');
                    p.textContent = email;
                    p.className = 'bg-gray-100 p-2 mb-2 rounded-md font-mono';
                    duplicateListContainer.appendChild(p);
                });
            } else {
                duplicateListContainer.innerHTML = '<p class="text-gray-500">No duplicate emails found. ðŸŽ‰</p>';
            }
        }

        // Initial duplicates update
        updateDuplicates();

        // Modal functionality
        const duplicateModal = document.getElementById('duplicateModal');
        const showDuplicatesBtn = document.getElementById('showDuplicatesBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');

        showDuplicatesBtn.addEventListener('click', () => {
            duplicateModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            duplicateModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target === duplicateModal) {
                duplicateModal.classList.add('hidden');
            }
        });

        // Select all functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        function attachSelectAll() {
            selectAllCheckbox.removeEventListener('change', selectAllHandler); // Prevent duplicate listeners
            selectAllCheckbox.addEventListener('change', selectAllHandler);
        }
        function selectAllHandler() {
            document.querySelectorAll('input[name="email_ids"]').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        }
        attachSelectAll();

        // Bulk actions
        document.getElementById('sendSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            const form = document.getElementById('emailForm');
            form.action = "{% url 'send_selected' %}";
            form.submit();
        });

        document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            if (confirm('Are you sure you want to delete the selected emails? This action cannot be undone.')) {
                const form = document.getElementById('emailForm');
                form.action = "{% url 'bulk_delete' %}";
                form.submit();
            }
        });

        // Real-time search and sorting
        const searchInput = document.getElementById('searchInput');
        function performSearch(query = '', sortBy = null, sortDir = 'asc') {
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (sortBy) params.append('sort_by', sortBy);
            if (sortDir) params.append('sort_dir', sortDir);

            fetch(`/ajax_search/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('emailTableBody');
                    tbody.innerHTML = '';
                    if (data.emails.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="5" class="text-center text-gray-500 py-4 text-sm"><i class="fas fa-inbox"></i> No emails found.</td>';
                        tbody.appendChild(tr);
                    } else {
                        data.emails.forEach((e, index) => {
                            const tr = document.createElement('tr');
                            tr.dataset.username = e.username;
                            tr.dataset.email = e.email;
                            tr.innerHTML = `
                                <td><input type="checkbox" name="email_ids" value="${e.id}"></td>
                                <td>${index + 1}</td>
                                <td>${e.username}</td>
                                <td>${e.email}</td>
                                <td><a href="/emails/delete/${e.id}/" class="text-red-500 hover:underline"><i class="fas fa-trash-alt"></i> Delete</a></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('showing').textContent = data.emails.length;
                    updateDuplicates();
                    attachSelectAll(); // Re-attach after update
                    // Update sort indicators
                    document.querySelectorAll('th.sortable').forEach(th => {
                        th.classList.remove('asc', 'desc');
                        th.querySelector('i').className = 'fas fa-sort ml-2';
                    });
                    if (sortBy) {
                        const activeTh = document.querySelector(`th[data-sort="${sortBy}"]`);
                        if (activeTh) {
                            activeTh.classList.add(sortDir);
                            const icon = activeTh.querySelector('i');
                            if (sortDir === 'asc') {
                                icon.className = 'fas fa-sort-alpha-up ml-2';
                            } else {
                                icon.className = 'fas fa-sort-alpha-down ml-2';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        searchInput.addEventListener('keyup', function() {
            currentSort.by = null; // Reset sort on new search
            performSearch(this.value, currentSort.by, currentSort.dir);
        });

        // Sorting functionality (server-side)
        document.querySelectorAll('th.sortable').forEach(headerCell => {
            headerCell.addEventListener('click', () => {
                const sortBy = headerCell.dataset.sort;
                let newDir = 'asc';
                if (currentSort.by === sortBy && currentSort.dir === 'asc') {
                    newDir = 'desc';
                }
                currentSort = { by: sortBy, dir: newDir };
                performSearch(searchInput.value, sortBy, newDir);
            });
        });

        // Initial load with possible sort
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q') || '';
        const initialSortBy = urlParams.get('sort_by') || null;
        const initialSortDir = urlParams.get('sort_dir') || 'asc';
        if (initialQuery || initialSortBy) {
            performSearch(initialQuery, initialSortBy, initialSortDir);
            searchInput.value = initialQuery;
            if (initialSortBy) {
                currentSort = { by: initialSortBy, dir: initialSortDir };
            }
        }
    });
</script>
{% endblock %}