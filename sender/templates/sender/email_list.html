{% extends 'sender/base.html' %}
{% load static %}

{% block content %}
<div class="card relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-[#1A3C34]/10 to-[#F59E0B]/10 opacity-50"></div>
    <h2 class="relative z-10 flex items-center gap-2 text-2xl font-bold text-[#1A3C34] mb-6">
        <i class="fas fa-envelope text-[#F59E0B]"></i> Email List
    </h2>
    <p class="relative z-10 text-gray-600 mb-6 text-sm">
        Total emails: <span id="total">{{ total }}</span> | Showing: <span id="showing">{{ emails.count }}</span>
    </p>
    <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
        <div class="relative flex-grow max-w-lg">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-[#1A3C34] text-lg"></i>
            <input type="text" id="searchInput" placeholder="Search by username or email" class="pl-12 pr-10 w-full border-[#D1E7F0] rounded-lg bg-white shadow-sm focus:border-[#F59E0B] focus:ring-2 focus:ring-[#F59E0B]/20 transition-all duration-300 py-2.5 text-sm">
            <button type="button" id="resetSearch" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-[#F59E0B] transition-colors duration-200 hidden">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex items-center gap-4 flex-wrap">
            <select id="pageSizeSelect" class="border-[#D1E7F0] rounded-lg px-3 py-2 bg-white shadow-sm focus:border-[#F59E0B] focus:ring-2 focus:ring-[#F59E0B]/20 transition-all duration-300 text-sm">
                <option value="5" {% if page_size == '5' %}selected{% endif %}>5</option>
                <option value="10" {% if page_size == '10' %}selected{% endif %}>10</option>
                <option value="25" {% if page_size == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if page_size == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if page_size == '100' %}selected{% endif %}>100</option>
                <option value="all" {% if page_size == 'all' %}selected{% endif %}>All</option>
            </select>
            <a href="{% url 'add_email' %}" class="btn bg-[#1A3C34] hover:bg-[#25544A] text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                <i class="fas fa-plus mr-2"></i> Add Email
            </a>
            <button type="button" id="sendSelectedBtn" class="btn bg-green-600 hover:bg-green-700 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                <i class="fas fa-paper-plane mr-2"></i> Send to Selected
            </button>
            <button type="button" id="deleteSelectedBtn" class="btn bg-red-600 hover:bg-red-700 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                <i class="fas fa-trash-alt mr-2"></i> Delete Selected
            </button>
        </div>
    </div>
    <form method="post" id="emailForm" class="relative z-10">
        {% csrf_token %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-[#D1E7F0] text-[#1A3C34] font-semibold">
                        <th class="w-12 text-center py-4">
                            <input type="checkbox" id="selectAll" class="accent-[#F59E0B] cursor-pointer">
                        </th>
                        <th class="w-16 text-center py-4">#</th>
                        <th class="w-1/3 py-4 cursor-pointer sortable" data-sort="username">
                            Username
                            <i class="fas fa-sort ml-2 transition-all duration-200"></i>
                        </th>
                        <th class="w-1/3 py-4 cursor-pointer sortable" data-sort="email">
                            Email
                            <i class="fas fa-sort ml-2 transition-all duration-200"></i>
                        </th>
                        <th class="w-1/6 text-center py-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="emailTableBody" class="bg-white">
                    {% for email in emails %}
                    <tr data-username="{{ email.username }}" data-email="{{ email.email }}" class="hover:bg-[#F7FAFC] transition-all duration-200 border-b border-[#E2E8F0]/50">
                        <td class="w-12 text-center py-3">
                            <input type="checkbox" name="email_ids" value="{{ email.id }}" class="accent-[#F59E0B] cursor-pointer">
                        </td>
                        <td class="w-16 text-center py-3 text-sm">{{ forloop.counter }}</td>
                        <td class="w-1/3 py-3 text-sm">{{ email.username }}</td>
                        <td class="w-1/3 py-3 text-sm">{{ email.email }}</td>
                        <td class="w-1/6 text-center py-3">
                            <a href="{% url 'delete_email' email.pk %}" class="text-red-500 hover:text-red-600 transition-colors duration-200 flex items-center justify-center gap-1 text-sm">
                                <i class="fas fa-trash-alt"></i> Delete
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-6 text-sm">
                            <i class="fas fa-inbox mr-2"></i> No emails found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if is_paginated %}
        <div class="pagination mt-6 flex justify-center gap-3">
            {% if page_obj.has_previous %}
            <a href="#" class="btn-paginate bg-[#F7FAFC] hover:bg-[#D1E7F0] text-[#1A3C34] px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-300" data-page="{{ page_obj.previous_page_number }}">Previous</a>
            {% endif %}
            <span class="px-4 py-2 text-[#1A3C34] text-sm">
                Page <span id="currentPage">{{ page_obj.number }}</span> of <span id="totalPages">{{ page_obj.paginator.num_pages }}</span>
            </span>
            {% if page_obj.has_next %}
            <a href="#" class="btn-paginate bg-[#F7FAFC] hover:bg-[#D1E7F0] text-[#1A3C34] px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-300" data-page="{{ page_obj.next_page_number }}">Next</a>
            {% endif %}
        </div>
        {% endif %}
    </form>
</div>

<style>
    .card {
        background-color: #F7FAFC;
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    table {
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    th {
        background-color: #D1E7F0;
        color: #1A3C34;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1rem;
    }
    th.sortable:hover {
        background-color: #B3D4E0;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    th.sortable.asc i, th.sortable.desc i {
        color: #F59E0B;
    }
    td {
        padding: 0.75rem;
        color: #2D3748;
        font-size: 0.875rem;
    }
    tr {
        transition: background-color 0.2s ease;
    }
    tr:hover {
        background-color: #F7FAFC;
    }
    input[type="checkbox"] {
        accent-color: #F59E0B;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 0.25rem;
        cursor: pointer;
    }
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    .btn:hover {
        background-image: linear-gradient(to right, #F59E0B, #D97706);
    }
    .btn-paginate {
        transition: all 0.3s ease;
    }
    #resetSearch {
        cursor: pointer;
    }
    #searchInput:not(:placeholder-shown) ~ #resetSearch {
        display: block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentSort = { by: null, dir: 'asc' };
        let currentPage = 1;

        // Select all functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        function attachSelectAll() {
            selectAllCheckbox.removeEventListener('change', selectAllHandler); // Prevent duplicate listeners
            selectAllCheckbox.addEventListener('change', selectAllHandler);
        }
        function selectAllHandler() {
            document.querySelectorAll('input[name="email_ids"]').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        }
        attachSelectAll();

        // Bulk actions
        document.getElementById('sendSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            const form = document.getElementById('emailForm');
            form.action = "{% url 'send_selected' %}";
            form.submit();
        });

        document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            if (confirm('Are you sure you want to delete the selected emails? This action cannot be undone.')) {
                const form = document.getElementById('emailForm');
                form.action = "{% url 'bulk_delete' %}";
                form.submit();
            }
        });

        // Real-time search, sorting, and pagination
        const searchInput = document.getElementById('searchInput');
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        const resetSearchBtn = document.getElementById('resetSearch');

        function performSearch(query = '', sortBy = null, sortDir = 'asc', page = 1, pageSize = '10') {
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (sortBy) params.append('sort_by', sortBy);
            if (sortDir) params.append('sort_dir', sortDir);
            if (page) params.append('page', page);
            if (pageSize) params.append('page_size', pageSize);

            fetch(`/ajax_search/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('emailTableBody');
                    tbody.innerHTML = '';
                    if (data.emails.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="5" class="text-center text-gray-500 py-6 text-sm"><i class="fas fa-inbox mr-2"></i> No emails found.</td>';
                        tbody.appendChild(tr);
                    } else {
                        data.emails.forEach((e, index) => {
                            const tr = document.createElement('tr');
                            tr.dataset.username = e.username;
                            tr.dataset.email = e.email;
                            tr.className = 'hover:bg-[#F7FAFC] transition-all duration-200 border-b border-[#E2E8F0]/50';
                            tr.innerHTML = `
                                <td class="w-12 text-center py-3"><input type="checkbox" name="email_ids" value="${e.id}" class="accent-[#F59E0B] cursor-pointer"></td>
                                <td class="w-16 text-center py-3 text-sm">${index + 1 + ((data.page - 1) * (pageSize === 'all' ? 0 : parseInt(pageSize)))}</td>
                                <td class="w-1/3 py-3 text-sm">${e.username}</td>
                                <td class="w-1/3 py-3 text-sm">${e.email}</td>
                                <td class="w-1/6 text-center py-3"><a href="/emails/delete/${e.id}/" class="text-red-500 hover:text-red-600 transition-colors duration-200 flex items-center justify-center gap-1 text-sm"><i class="fas fa-trash-alt"></i> Delete</a></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('showing').textContent = data.emails.length;
                    attachSelectAll(); // Re-attach after update

                    // Update pagination controls
                    let paginationDiv = document.querySelector('.pagination');
                    if (pageSize === 'all' || data.num_pages <= 1) {
                        if (paginationDiv) paginationDiv.style.display = 'none';
                    } else {
                        if (!paginationDiv) {
                            const newPagination = document.createElement('div');
                            newPagination.className = 'pagination mt-6 flex justify-center gap-3';
                            document.querySelector('#emailForm').appendChild(newPagination);
                            paginationDiv = newPagination;
                        }
                        paginationDiv.style.display = 'flex';
                        document.getElementById('currentPage').textContent = data.page;
                        document.getElementById('totalPages').textContent = data.num_pages;
                        const prevBtn = paginationDiv.querySelector('.btn-paginate[data-page="previous"]');
                        const nextBtn = paginationDiv.querySelector('.btn-paginate[data-page="next"]');
                        if (prevBtn) prevBtn.remove();
                        if (nextBtn) nextBtn.remove();
                        if (data.has_previous) {
                            const prevLink = document.createElement('a');
                            prevLink.href = '#';
                            prevLink.className = 'btn-paginate bg-[#F7FAFC] hover:bg-[#D1E7F0] text-[#1A3C34] px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-300';
                            prevLink.dataset.page = data.page - 1;
                            prevLink.textContent = 'Previous';
                            paginationDiv.insertBefore(prevLink, paginationDiv.firstChild);
                        }
                        if (data.has_next) {
                            const nextLink = document.createElement('a');
                            nextLink.href = '#';
                            nextLink.className = 'btn-paginate bg-[#F7FAFC] hover:bg-[#D1E7F0] text-[#1A3C34] px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-300';
                            nextLink.dataset.page = data.page + 1;
                            nextLink.textContent = 'Next';
                            paginationDiv.appendChild(nextLink);
                        }
                    }

                    // Update sort indicators
                    document.querySelectorAll('th.sortable').forEach(th => {
                        th.classList.remove('asc', 'desc');
                        th.querySelector('i').className = 'fas fa-sort ml-2 transition-all duration-200';
                    });
                    if (sortBy) {
                        const activeTh = document.querySelector(`th[data-sort="${sortBy}"]`);
                        if (activeTh) {
                            activeTh.classList.add(sortDir);
                            const icon = activeTh.querySelector('i');
                            if (sortDir === 'asc') {
                                icon.className = 'fas fa-sort-alpha-up ml-2 transition-all duration-200';
                            } else {
                                icon.className = 'fas fa-sort-alpha-down ml-2 transition-all duration-200';
                            }
                        }
                    }

                    // Re-attach pagination listeners
                    document.querySelectorAll('.btn-paginate').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            currentPage = parseInt(btn.dataset.page);
                            performSearch(searchInput.value, currentSort.by, currentSort.dir, currentPage, pageSizeSelect.value);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Search input handling
        searchInput.addEventListener('input', function() {
            resetSearchBtn.classList.toggle('hidden', this.value === '');
            currentSort.by = null; // Reset sort on new search
            currentPage = 1; // Reset page on new search
            performSearch(this.value, currentSort.by, currentSort.dir, currentPage, pageSizeSelect.value);
        });

        // Reset search functionality
        resetSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            this.classList.add('hidden');
            currentSort.by = null;
            currentPage = 1;
            performSearch('', currentSort.by, currentSort.dir, currentPage, pageSizeSelect.value);
            searchInput.focus();
        });

        // Page size change handling
        pageSizeSelect.addEventListener('change', function() {
            currentPage = 1; // Reset to first page on size change
            performSearch(searchInput.value, currentSort.by, currentSort.dir, currentPage, this.value);
        });

        // Sorting functionality (server-side)
        document.querySelectorAll('th.sortable').forEach(headerCell => {
            headerCell.addEventListener('click', () => {
                const sortBy = headerCell.dataset.sort;
                let newDir = 'asc';
                if (currentSort.by === sortBy && currentSort.dir === 'asc') {
                    newDir = 'desc';
                }
                currentSort = { by: sortBy, dir: newDir };
                currentPage = 1; // Reset to first page on sort
                performSearch(searchInput.value, sortBy, newDir, currentPage, pageSizeSelect.value);
            });
        });

        // Initial load with possible search, sort, and pagination
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q') || '';
        const initialSortBy = urlParams.get('sort_by') || null;
        const initialSortDir = urlParams.get('sort_dir') || 'asc';
        const initialPage = urlParams.get('page') || 1;
        const initialPageSize = urlParams.get('page_size') || '10';
        if (initialQuery || initialSortBy || initialPage !== '1' || initialPageSize !== '10') {
            performSearch(initialQuery, initialSortBy, initialSortDir, initialPage, initialPageSize);
            searchInput.value = initialQuery;
            pageSizeSelect.value = initialPageSize;
            if (initialQuery) resetSearchBtn.classList.remove('hidden');
            if (initialSortBy) {
                currentSort = { by: initialSortBy, dir: initialSortDir };
            }
            currentPage = parseInt(initialPage);
        }
    });
</script>
{% endblock %}