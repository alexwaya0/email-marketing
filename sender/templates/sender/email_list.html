{% extends 'sender/base.html' %}
{% load static %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-envelope"></i> Email List</h2>
    <p>Total emails: <span id="total">{{ total }}</span> | Showing: <span id="showing">{{ emails.count }}</span></p>
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
        <div class="relative flex-grow">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-[#1A3C34]"></i>
            <input type="text" id="searchInput" placeholder="Search by username or email" class="pl-10 w-full">
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <select id="pageSizeSelect" class="border rounded px-2 py-1">
                <option value="5" {% if page_size == '5' %}selected{% endif %}>5</option>
                <option value="10" {% if page_size == '10' %}selected{% endif %}>10</option>
                <option value="25" {% if page_size == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if page_size == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if page_size == '100' %}selected{% endif %}>100</option>
                <option value="all" {% if page_size == 'all' %}selected{% endif %}>All</option>
            </select>
            <a href="{% url 'add_email' %}" class="btn"><i class="fas fa-plus"></i> Add Email</a>
            <button id="showDuplicatesBtn" class="btn bg-red-600 hover:bg-red-700 text-white flex items-center gap-2">
                <i class="fas fa-exclamation-triangle"></i> Find Duplicates (<span id="duplicateCount">0</span>)
            </button>
            <a href="{% url 'send_emails' %}" class="btn bg-blue-600 hover:bg-blue-700 text-white"><i class="fas fa-paper-plane"></i> Send to All</a>
        </div>
    </div>
    <form method="post" id="emailForm">
        {% csrf_token %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="w-12 text-center"><input type="checkbox" id="selectAll"></th>
                        <th class="w-16 text-center">#</th>
                        <th class="w-1/3 cursor-pointer sortable" data-sort="username">Username <i class="fas fa-sort ml-2"></i></th>
                        <th class="w-1/3 cursor-pointer sortable" data-sort="email">Email <i class="fas fa-sort ml-2"></i></th>
                        <th class="w-1/6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="emailTableBody">
                    {% for email in emails %}
                    <tr data-username="{{ email.username }}" data-email="{{ email.email }}">
                        <td class="w-12 text-center"><input type="checkbox" name="email_ids" value="{{ email.id }}"></td>
                        <td class="w-16 text-center">{{ forloop.counter }}</td>
                        <td class="w-1/3">{{ email.username }}</td>
                        <td class="w-1/3">{{ email.email }}</td>
                        <td class="w-1/6 text-center">
                            <a href="{% url 'delete_email' email.pk %}" class="text-red-500 hover:underline"><i class="fas fa-trash-alt"></i> Delete</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-gray-500 py-4 text-sm"><i class="fas fa-inbox"></i> No emails found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if is_paginated %}
        <div class="pagination mt-4 flex justify-center gap-2">
            {% if page_obj.has_previous %}
            <a href="#" class="btn-paginate" data-page="{{ page_obj.previous_page_number }}">Previous</a>
            {% endif %}
            <span>Page <span id="currentPage">{{ page_obj.number }}</span> of <span id="totalPages">{{ page_obj.paginator.num_pages }}</span></span>
            {% if page_obj.has_next %}
            <a href="#" class="btn-paginate" data-page="{{ page_obj.next_page_number }}">Next</a>
            {% endif %}
        </div>
        {% endif %}
        <div class="mt-4 flex gap-2">
            <button type="button" id="sendSelectedBtn" class="btn bg-green-600 hover:bg-green-700 text-white"><i class="fas fa-paper-plane"></i> Send to Selected</button>
            <button type="button" id="deleteSelectedBtn" class="btn bg-red-600 hover:bg-red-700 text-white"><i class="fas fa-trash-alt"></i> Delete Selected</button>
        </div>
    </form>
</div>

<div id="duplicateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3">
            <h3 class="text-lg font-bold">Duplicate Emails</h3>
            <button id="closeModalBtn" class="text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
        </div>
        <div class="mt-2 text-gray-600">
            <p>Found <span id="modalDuplicateCount">0</span> duplicate emails.</p>
            <div id="duplicateList" class="mt-4 max-h-64 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentSort = { by: null, dir: 'asc' };
        let currentPage = 1;

        // Function to update duplicates
        function updateDuplicates() {
            const emailRows = document.querySelectorAll('#emailTableBody tr:not([colspan])');
            const emailList = [];
            emailRows.forEach(row => {
                const email = row.dataset.email.trim().toLowerCase();
                emailList.push(email);
            });

            const seenEmails = new Set();
            const duplicates = new Set();
            emailList.forEach(email => {
                if (seenEmails.has(email)) {
                    duplicates.add(email);
                }
                seenEmails.add(email);
            });

            const duplicateCountElement = document.getElementById('duplicateCount');
            const modalDuplicateCountElement = document.getElementById('modalDuplicateCount');
            duplicateCountElement.textContent = duplicates.size;
            modalDuplicateCountElement.textContent = duplicates.size;

            const duplicateListContainer = document.getElementById('duplicateList');
            duplicateListContainer.innerHTML = '';
            if (duplicates.size > 0) {
                duplicates.forEach(email => {
                    const p = document.createElement('p');
                    p.textContent = email;
                    p.className = 'bg-gray-100 p-2 mb-2 rounded-md font-mono';
                    duplicateListContainer.appendChild(p);
                });
            } else {
                duplicateListContainer.innerHTML = '<p class="text-gray-500">No duplicate emails found. ðŸŽ‰</p>';
            }
        }

        // Initial duplicates update
        updateDuplicates();

        // Modal functionality
        const duplicateModal = document.getElementById('duplicateModal');
        const showDuplicatesBtn = document.getElementById('showDuplicatesBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');

        showDuplicatesBtn.addEventListener('click', () => {
            duplicateModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            duplicateModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target === duplicateModal) {
                duplicateModal.classList.add('hidden');
            }
        });

        // Select all functionality
        const selectAllCheckbox = document.getElementById('selectAll');
        function attachSelectAll() {
            selectAllCheckbox.removeEventListener('change', selectAllHandler); // Prevent duplicate listeners
            selectAllCheckbox.addEventListener('change', selectAllHandler);
        }
        function selectAllHandler() {
            document.querySelectorAll('input[name="email_ids"]').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        }
        attachSelectAll();

        // Bulk actions
        document.getElementById('sendSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            const form = document.getElementById('emailForm');
            form.action = "{% url 'send_selected' %}";
            form.submit();
        });

        document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('input[name="email_ids"]:checked');
            if (checkedBoxes.length === 0) {
                alert('No emails selected.');
                return;
            }
            if (confirm('Are you sure you want to delete the selected emails? This action cannot be undone.')) {
                const form = document.getElementById('emailForm');
                form.action = "{% url 'bulk_delete' %}";
                form.submit();
            }
        });

        // Real-time search, sorting, and pagination
        const searchInput = document.getElementById('searchInput');
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        function performSearch(query = '', sortBy = null, sortDir = 'asc', page = 1, pageSize = '10') {
            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (sortBy) params.append('sort_by', sortBy);
            if (sortDir) params.append('sort_dir', sortDir);
            if (page) params.append('page', page);
            if (pageSize) params.append('page_size', pageSize);

            fetch(`/ajax_search/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('emailTableBody');
                    tbody.innerHTML = '';
                    if (data.emails.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td colspan="5" class="text-center text-gray-500 py-4 text-sm"><i class="fas fa-inbox"></i> No emails found.</td>';
                        tbody.appendChild(tr);
                    } else {
                        data.emails.forEach((e, index) => {
                            const tr = document.createElement('tr');
                            tr.dataset.username = e.username;
                            tr.dataset.email = e.email;
                            tr.innerHTML = `
                                <td class="w-12 text-center"><input type="checkbox" name="email_ids" value="${e.id}"></td>
                                <td class="w-16 text-center">${index + 1 + ((data.page - 1) * (pageSize === 'all' ? 0 : parseInt(pageSize)))}</td>
                                <td class="w-1/3">${e.username}</td>
                                <td class="w-1/3">${e.email}</td>
                                <td class="w-1/6 text-center"><a href="/emails/delete/${e.id}/" class="text-red-500 hover:underline"><i class="fas fa-trash-alt"></i> Delete</a></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('showing').textContent = data.emails.length;
                    updateDuplicates();
                    attachSelectAll(); // Re-attach after update

                    // Update pagination controls
                    let paginationDiv = document.querySelector('.pagination');
                    if (pageSize === 'all' || data.num_pages <= 1) {
                        if (paginationDiv) paginationDiv.style.display = 'none';
                    } else {
                        if (!paginationDiv) {
                            const newPagination = document.createElement('div');
                            newPagination.className = 'pagination mt-4 flex justify-center gap-2';
                            document.querySelector('#emailForm').insertBefore(newPagination, document.querySelector('.mt-4.flex.gap-2'));
                            paginationDiv = newPagination;
                        }
                        paginationDiv.style.display = 'flex';
                        document.getElementById('currentPage').textContent = data.page;
                        document.getElementById('totalPages').textContent = data.num_pages;
                        const prevBtn = paginationDiv.querySelector('.btn-paginate[data-page="previous"]');
                        const nextBtn = paginationDiv.querySelector('.btn-paginate[data-page="next"]');
                        if (prevBtn) prevBtn.remove();
                        if (nextBtn) nextBtn.remove();
                        if (data.has_previous) {
                            const prevLink = document.createElement('a');
                            prevLink.href = '#';
                            prevLink.className = 'btn-paginate';
                            prevLink.dataset.page = data.page - 1;
                            prevLink.textContent = 'Previous';
                            paginationDiv.insertBefore(prevLink, paginationDiv.firstChild);
                        }
                        if (data.has_next) {
                            const nextLink = document.createElement('a');
                            nextLink.href = '#';
                            nextLink.className = 'btn-paginate';
                            nextLink.dataset.page = data.page + 1;
                            nextLink.textContent = 'Next';
                            paginationDiv.appendChild(nextLink);
                        }
                    }

                    // Update sort indicators
                    document.querySelectorAll('th.sortable').forEach(th => {
                        th.classList.remove('asc', 'desc');
                        th.querySelector('i').className = 'fas fa-sort ml-2';
                    });
                    if (sortBy) {
                        const activeTh = document.querySelector(`th[data-sort="${sortBy}"]`);
                        if (activeTh) {
                            activeTh.classList.add(sortDir);
                            const icon = activeTh.querySelector('i');
                            if (sortDir === 'asc') {
                                icon.className = 'fas fa-sort-alpha-up ml-2';
                            } else {
                                icon.className = 'fas fa-sort-alpha-down ml-2';
                            }
                        }
                    }

                    // Re-attach pagination listeners
                    document.querySelectorAll('.btn-paginate').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            currentPage = parseInt(btn.dataset.page);
                            performSearch(searchInput.value, currentSort.by, currentSort.dir, currentPage, pageSizeSelect.value);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        searchInput.addEventListener('keyup', function() {
            currentSort.by = null; // Reset sort on new search
            currentPage = 1; // Reset page on new search
            performSearch(this.value, currentSort.by, currentSort.dir, currentPage, pageSizeSelect.value);
        });

        pageSizeSelect.addEventListener('change', function() {
            currentPage = 1; // Reset to first page on size change
            performSearch(searchInput.value, currentSort.by, currentSort.dir, currentPage, this.value);
        });

        // Sorting functionality (server-side)
        document.querySelectorAll('th.sortable').forEach(headerCell => {
            headerCell.addEventListener('click', () => {
                const sortBy = headerCell.dataset.sort;
                let newDir = 'asc';
                if (currentSort.by === sortBy && currentSort.dir === 'asc') {
                    newDir = 'desc';
                }
                currentSort = { by: sortBy, dir: newDir };
                currentPage = 1; // Reset to first page on sort
                performSearch(searchInput.value, sortBy, newDir, currentPage, pageSizeSelect.value);
            });
        });

        // Initial load with possible search, sort, and pagination
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q') || '';
        const initialSortBy = urlParams.get('sort_by') || null;
        const initialSortDir = urlParams.get('sort_dir') || 'asc';
        const initialPage = urlParams.get('page') || 1;
        const initialPageSize = urlParams.get('page_size') || '10';
        if (initialQuery || initialSortBy || initialPage !== '1' || initialPageSize !== '10') {
            performSearch(initialQuery, initialSortBy, initialSortDir, initialPage, initialPageSize);
            searchInput.value = initialQuery;
            pageSizeSelect.value = initialPageSize;
            if (initialSortBy) {
                currentSort = { by: initialSortBy, dir: initialSortDir };
            }
            currentPage = parseInt(initialPage);
        }
    });
</script>
{% endblock %}